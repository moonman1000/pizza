<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>App do Motorista - Debug</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{font-family:system-ui,Roboto,Arial;background:#0b0d12;color:#e6e9ef;padding:16px}
    #map{height:420px;border-radius:12px;border:1px solid #1d2236}
    input{background:#0f1426;border:1px solid #1d2236;border-radius:10px;color:#e6e9ef;padding:10px;width:100%;margin:8px 0}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;background:#3a86ff;color:#fff;cursor:pointer;font-weight:600;transition:all 0.3s}
    .btn:hover{background:#2563eb}
    .btn:disabled{background:#374151;cursor:not-allowed;opacity:0.6}
    .btn.online{background:#10b981}
    .status{background:#1f2937;padding:12px;border-radius:8px;margin:12px 0;font-size:14px}
    .error{background:#dc2626;color:white}
    .success{background:#059669;color:white}
    .info{background:#0ea5e9;color:white}
    .debug{background:#1f2937;padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto}
  </style>
</head>
<body>
  <h2>App do Motorista - Debug</h2>
  <p>Teste de comunica√ß√£o com o servidor</p>
  
  <div id="status" class="status">
    üîÑ Inicializando...
  </div>
  
  <input id="nome" placeholder="Seu nome" value="Jo√£o Teste"/>
  <input id="placa" placeholder="Placa do ve√≠culo" value="ABC-1234"/>
  <button class="btn" id="registrar">Entrar online</button>
  
  <div class="debug" id="debug">
    <strong>Debug Log:</strong><br>
  </div>
  
  <div id="map" style="margin-top:12px;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Vari√°veis globais
    let socket = null;
    let map = null;
    let marker = null; 
    let online = false;
    
    // Elementos DOM
    const statusDiv = document.getElementById('status');
    const debugDiv = document.getElementById('debug');
    const nomeInput = document.getElementById('nome');
    const placaInput = document.getElementById('placa');
    const registrarBtn = document.getElementById('registrar');

    // Log debug
    function debugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}]`, message, data || '');
      debugDiv.innerHTML += `<br>[${timestamp}] ${message}`;
      if (data) {
        debugDiv.innerHTML += `<br>  Data: ${JSON.stringify(data, null, 2)}`;
      }
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    // Fun√ß√µes de status
    function updateStatus(message, type = 'info') {
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
      debugLog(`Status: ${message} (${type})`);
    }

    // Inicializar mapa
    function initMap() {
      try {
        map = L.map('map').setView([-23.55, -46.63], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        updateStatus('üó∫Ô∏è Mapa carregado', 'success');
      } catch (error) {
        debugLog('Erro no mapa:', error);
        updateStatus('‚ùå Erro no mapa', 'error');
      }
    }

    // Testar APIs
    async function testAPIs() {
      debugLog('üîç Testando APIs do servidor...');
      
      try {
        // Testar health check
        const healthResponse = await fetch('/healthz');
        if (healthResponse.ok) {
          const healthData = await healthResponse.json();
          debugLog('‚úÖ Health check OK:', healthData);
        } else {
          debugLog('‚ùå Health check falhou:', healthResponse.status);
        }
      } catch (error) {
        debugLog('‚ùå Erro no health check:', error.message);
      }
      
      try {
        // Testar API de motoristas
        const driversResponse = await fetch('/api/admin/drivers');
        if (driversResponse.ok) {
          const driversData = await driversResponse.json();
          debugLog('‚úÖ API drivers OK:', driversData);
        } else {
          debugLog('‚ùå API drivers falhou:', driversResponse.status);
        }
      } catch (error) {
        debugLog('‚ùå Erro na API drivers:', error.message);
      }
    }

    // Inicializar Socket.IO
    function initSocket() {
      debugLog('üîå Iniciando Socket.IO...');
      
      try {
        // Verificar se Socket.IO est√° dispon√≠vel
        if (typeof io === 'undefined') {
          updateStatus('‚ùå Socket.IO n√£o carregou', 'error');
          return;
        }
        
        socket = io();
        
        // Event listeners do socket
        socket.on('connect', () => {
          debugLog('‚úÖ Socket conectado, ID:', socket.id);
          updateStatus('‚úÖ Conectado ao servidor', 'success');
          registrarBtn.disabled = false;
        });
        
        socket.on('disconnect', (reason) => {
          debugLog('‚ùå Socket desconectado:', reason);
          updateStatus('‚ùå Desconectado', 'error');
          registrarBtn.disabled = true;
        });
        
        socket.on('connect_error', (error) => {
          debugLog('‚ùå Erro de conex√£o:', error.message);
          updateStatus('‚ùå Erro de conex√£o', 'error');
        });
        
        // Escutar TODOS os eventos para debug
        socket.onAny((eventName, ...args) => {
          debugLog(`üì® Evento recebido: ${eventName}`, args);
        });
        
        // Eventos espec√≠ficos do motorista
        socket.on('driverRegistered', (data) => {
          debugLog('‚úÖ Motorista registrado:', data);
          updateStatus('‚úÖ Registrado como: ' + (data.name || 'motorista'), 'success');
          setOnlineState();
        });
        
        socket.on('driversUpdate', (data) => {
          debugLog('üìä Atualiza√ß√£o de motoristas:', data);
        });
        
      } catch (error) {
        debugLog('‚ùå Erro ao inicializar socket:', error);
        updateStatus('‚ùå Erro no Socket.IO', 'error');
      }
    }

    // Estados do bot√£o
    function setOnlineState() {
      online = true;
      registrarBtn.textContent = 'Sair offline';
      registrarBtn.className = 'btn online';
    }
    
    function setOfflineState() {
      online = false;
      registrarBtn.textContent = 'Entrar online';
      registrarBtn.className = 'btn';
    }

    // Geolocaliza√ß√£o
    function onPosition(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      
      debugLog('üìç Posi√ß√£o obtida:', { lat, lon, accuracy });
      
      if (marker) {
        marker.setLatLng([lat, lon]);
      } else {
        marker = L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`Voc√™<br>Precis√£o: ${Math.round(accuracy)}m`);
      }
      
      map.setView([lat, lon], 16);
      
      if (online && socket && socket.connected) {
        const locationData = { lat, lon, accuracy, timestamp: Date.now() };
        socket.emit('localizacaoMotorista', locationData);
        debugLog('üì° Localiza√ß√£o enviada:', locationData);
      }
    }
    
    function onPositionError(error) {
      debugLog('‚ùå Erro de geolocaliza√ß√£o:', { code: error.code, message: error.message });
      updateStatus('‚ùå Erro de localiza√ß√£o', 'error');
    }

    // Event listener do bot√£o
    function handleRegistrarClick() {
      debugLog('üñ±Ô∏è Bot√£o clicado, estado online:', online);
      
      if (!online) {
        // Entrar online
        const name = nomeInput.value.trim();
        const plate = placaInput.value.trim();
        
        if (!name) {
          alert('Informe seu nome');
          return;
        }
        
        if (!socket || !socket.connected) {
          updateStatus('‚ùå Socket n√£o conectado', 'error');
          debugLog('‚ùå Tentativa de registro sem conex√£o');
          return;
        }
        
        const driverData = { name, plate, timestamp: Date.now() };
        debugLog('üì§ Enviando registerDriver:', driverData);
        
        socket.emit('registerDriver', driverData);
        updateStatus('üîÑ Registrando...', 'info');
        
        // Iniciar geolocaliza√ß√£o
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(onPosition, onPositionError, {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 20000
          });
          debugLog('üéØ Geolocaliza√ß√£o iniciada');
        }
        
      } else {
        // Sair offline
        debugLog('üì§ Enviando driverOffline');
        socket.emit('driverOffline');
        setOfflineState();
        updateStatus('üì¥ Offline', 'info');
      }
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('üöÄ Aplica√ß√£o iniciada');
      
      initMap();
      initSocket();
      testAPIs();
      
      registrarBtn.addEventListener('click', handleRegistrarClick);
      registrarBtn.disabled = true;
    });

    // Fun√ß√µes globais para debug no console
    window.debugMotorista = {
      socket: () => socket,
      enviarTeste: () => {
        if (socket) {
          socket.emit('teste', { message: 'teste do console', timestamp: Date.now() });
          debugLog('üì§ Teste enviado via console');
        }
      },
      status: () => ({ online, connected: socket?.connected, id: socket?.id }),
      clearDebug: () => { debugDiv.innerHTML = '<strong>Debug Log:</strong><br>'; }
    };
  </script>
</body>
</html>

