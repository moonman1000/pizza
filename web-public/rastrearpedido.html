<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rastreio do Pedido</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{font-family:system-ui,Roboto,Arial;background:#0b0d12;color:#e6e9ef;padding:16px}
    .wrap{max-width:980px;margin:0 auto}
    #map{height:440px;border-radius:12px;border:1px solid #1d2236}
    .pill{display:inline-block;background:#12172a;border:1px solid #1d2236;border-radius:999px;padding:8px 12px;margin:8px 0;color:#9aa4b2}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Rastreie seu pedido</h2>
    <div id="eta" class="pill">Aguardando motorista...</div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const url = new URL(location.href);
    const tracking = url.searchParams.get('code') || '';
    const socket = io();
    let destino = null;
    let marcadorMotorista = null;
    let rota = null;
    const map = L.map('map').setView([-23.55,-46.63], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    function fmt(mins){
      const h=Math.floor(mins/60);
      const m=Math.max(0,Math.round(mins%60));
      return h>0?`${h}h ${m}min`:`${m}min`;
    }

    async function boot(){
      if(!tracking){ alert('Código de rastreio ausente'); return; }
      const r = await fetch('/api/orders/'+encodeURIComponent(tracking));
      const data = await r.json();
      destino = { lat:data.customer_lat, lon:data.customer_lon };
      L.marker([destino.lat, destino.lon]).addTo(map).bindPopup('Endereço de entrega').openPopup();
      map.setView([destino.lat, destino.lon], 13);

      socket.emit('joinOrder', { tracking_code: tracking });

      socket.on('atualizacaoLocalizacao', ({lat,lon})=>{
        if(marcadorMotorista){ marcadorMotorista.setLatLng([lat,lon]); }
        else { marcadorMotorista = L.marker([lat,lon]).addTo(map).bindPopup('Motorista'); }
        atualizarRota(lat,lon,destino.lat,destino.lon);
      });

      socket.on('rotaAtualizada', ({etaMin})=>{
        document.getElementById('eta').textContent = 'Tempo estimado: ' + fmt(etaMin);
      });

      if(data.delivery_eta_min){
        document.getElementById('eta').textContent = 'Tempo estimado: ' + fmt(data.delivery_eta_min);
      }
    }

    async function atualizarRota(fromLat, fromLon, toLat, toLon){
      try{
        const resp = await fetch(`/api/routes?from=${fromLat},${fromLon}&to=${toLat},${toLon}`);
        const data = await resp.json();
        if(rota){ rota.setLatLngs(data.coords); }
        else { rota = L.polyline(data.coords,{ weight:5, opacity:.75 }).addTo(map); }
        map.fitBounds(rota.getBounds(),{ padding:[18,18] });
        document.getElementById('eta').textContent = 'Tempo estimado: ' + fmt(data.etaMin);
      }catch(e){ console.error(e); }
    }

    boot();
  </script>
</body>
</html>
