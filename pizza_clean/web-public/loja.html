<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pizzaria ‚Äî Loja</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';background:#0b0d12;color:#e6e9ef}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:#111423;position:sticky;top:0;z-index:10;border-bottom:1px solid #1d2236}
    .brand{font-weight:800;letter-spacing:.3px}
    .tag{font-size:12px;background:#1d2236;color:#9aa4b2;padding:4px 8px;border-radius:999px;margin-left:8px}
    main{display:grid;grid-template-columns:2fr 1fr;gap:24px;max-width:1200px;margin:24px auto;padding:0 24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#12172a;border:1px solid #1d2236;border-radius:16px;overflow:hidden}
    .card img{width:100%;height:140px;object-fit:cover;display:block}
    .card .p{padding:12px}
    .card h4{margin:0 0 6px;font-size:16px}
    .muted{color:#9aa4b2;font-size:13px}
    .price{font-weight:700;margin-top:8px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:#3a86ff;color:#fff;cursor:pointer;font-weight:600}
    .btn.secondary{background:#2b324a}
    .panel{background:#12172a;border:1px solid #1d2236;border-radius:16px;padding:16px;position:sticky;top:92px;height:fit-content}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    input,select{background:#0f1426;border:1px solid #1d2236;border-radius:10px;color:#e6e9ef;padding:10px;width:100%}
    .line{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .total{font-size:18px;font-weight:800}
    footer{max-width:1200px;margin:36px auto;padding:0 24px;color:#8b95a9}
  </style>
</head>
<body>
  <header>
    <div class="brand">üçï Nebula Pizza <span class="tag">online</span></div>
    <nav><a href="/admin.html" class="btn secondary">√Årea Admin</a></nav>
  </header>

  <main>
    <section>
      <h2>Card√°pio</h2>
      <div id="menu" class="grid"></div>
    </section>

    <aside class="panel">
      <h3>Seu pedido</h3>
      <div id="cart"></div>
      <div class="line"><span class="muted">Subtotal</span><strong id="subtotal">R$ 0,00</strong></div>
      <div class="line"><span class="muted">Taxa de entrega (estimada)</span><strong id="taxa">R$ 0,00</strong></div>
      <div class="line total"><span>Total</span><span id="total">R$ 0,00</span></div>
      <div class="row"><input id="endereco" placeholder="Endere√ßo completo para entrega"/></div>
      <div class="row">
        <select id="pagamento">
          <option value="pix">PIX (simulado)</option>
          <option value="card">Cart√£o (sandbox)</option>
        </select>
      </div>
      <button class="btn" id="finalizar">Finalizar pedido</button>
      <p class="muted" id="mensagem"></p>
    </aside>
  </main>

  <footer>
    Este √© um MVP. Rotas e ETA s√£o calculados no backend em <code>/api/routes</code>. Pedidos ficam em mem√≥ria.
  </footer>

  <script>
    const formatBRL = (v)=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const menu = [
      {id:'m1', nome:'Margherita', preco: 39.9, foto:'https://images.unsplash.com/photo-1548365328-9f547fb0953c?q=80&w=1200&auto=format&fit=crop'},
      {id:'m2', nome:'Calabresa', preco: 44.9, foto:'https://images.unsplash.com/photo-1593504049359-74330189a345?q=80&w=1200&auto=format&fit=crop'},
      {id:'m3', nome:'Quatro Queijos', preco: 49.9, foto:'https://images.unsplash.com/photo-1604382354936-07c5d9983bd3?q=80&w=1200&auto=format&fit=crop'},
      {id:'m4', nome:'Frango com Catupiry', preco: 52.9, foto:'https://images.unsplash.com/photo-1542281286-9e0a16bb7366?q=80&w=1200&auto=format&fit=crop'}
    ];

    const cart = {};

    function renderMenu(){
      const el = document.getElementById('menu');
      el.innerHTML = '';
      menu.forEach(item=>{
        const c = document.createElement('div');
        c.className='card';
        c.innerHTML = `
          <img src="${item.foto}" alt="${item.nome}"/>
          <div class="p">
            <h4>${item.nome}</h4>
            <div class="muted">Tamanho √∫nico, 8 fatias</div>
            <div class="price">${formatBRL(item.preco)}</div>
            <div style="margin-top:10px;"><button class="btn" data-id="${item.id}">Adicionar</button></div>
          </div>`;
        el.appendChild(c);
      });
      el.querySelectorAll('button[data-id]').forEach(b=>b.onclick=()=>{
        const id=b.dataset.id; const it=menu.find(x=>x.id===id);
        cart[id]=(cart[id]||{q:0,item:it}); cart[id].q++;
        renderCart();
      });
    }

    function sumCart(){
      return Object.values(cart).reduce((acc,{q,item})=>acc+q*item.preco,0);
    }

    function renderCart(){
      const c = document.getElementById('cart'); c.innerHTML='';
      Object.values(cart).forEach(({q,item})=>{
        const d = document.createElement('div'); d.className='line';
        d.innerHTML = `<span>${item.nome} √ó ${q}</span><strong>${formatBRL(q*item.preco)}</strong>`;
        c.appendChild(d);
      });
      const subtotal = sumCart();
      document.getElementById('subtotal').textContent = formatBRL(subtotal);
      const taxa = Math.max(6, subtotal*0.05);
      document.getElementById('taxa').textContent = formatBRL(taxa);
      document.getElementById('total').textContent = formatBRL(subtotal+taxa);
    }

    renderMenu(); 
    renderCart();

    async function finalizarPedido(){
      const endereco = document.getElementById('endereco').value.trim();
      if(!endereco) { alert('Informe o endere√ßo'); return; }
      if(Object.keys(cart).length===0){ alert('Seu carrinho est√° vazio'); return; }
      const items = Object.values(cart).map(({q,item})=>({menuId:item.id, nome:item.nome, quantidade:q, preco:item.preco}));
      const body = { address_text:endereco, items, payment_method: document.getElementById('pagamento').value };
      const r = await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data = await r.json();
      if(!r.ok){ alert(data.error||'Erro ao criar pedido'); return; }
      window.location.href = '/rastrearpedido.html?code='+encodeURIComponent(data.tracking_code);
    }
    document.getElementById('finalizar').onclick = finalizarPedido;
  </script>
</body>
</html>
